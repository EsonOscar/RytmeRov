{% extends "base.html" %}

{% block content %}

<div class = "container py-4">
    <h1 class = "mb-4">Find patienter</h1>

<!-- Flash beskeder -->
    {% with messaged = get_flashed_messages(with_categories=true) %}
        {% if messaged %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                  {{ message }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}


    <!-- Søgefelt til CPR-nummer-->
    <div class="my-4">
        <label for="patientSearch" class="form-label"><strong>Søg efter CPR-nummer</strong></label>
        <div class="input-group mb-3">
            <input
                type="text"
                class="form-control"
                id="patientSearch"
                name="patient_search"
                placeholder="xxxxxx-xxxx"
                inputmode="numeric"
                pattern="[0-9\-]*"
            >

            <!--Knappen der manuelt starter en søgning-->
            <button type="button" class="btn btn-primary" id="searchBtn">Søg</button>
        </div>
        <small class="form-text text-muted">Kun tal og bindestreg tilladt!</small>
    </div>

    <!-- Search Results Container -->
    <div id="searchResults" class="mt-4"></div>
</div>

<!--hent HTML-elementer -->
<script>
    const searchInput = document.getElementById('patientSearch');
    const searchBtn = document.getElementById('searchBtn');
    const searchResults = document.getElementById('searchResults');
    let searchTimeout; //debounce

    //funktion til at escape HTML-tegn i patient id (for at ungå xss)
    function escapeHtml(str) {
        if (str === null || str === undefined) return  '';
        return str
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
    
// Bindestreg automatisk indsættes efter 6 cifre
    searchInput.addEventListener('input', function(e) {
        // fjerner alle tal der ikke er tal eller bindestreg
        let value = this.value.replace(/[^0-9\-]/g, '');
        
        // fjerner alle bindestreger for at arbejde med rene tal
        let digitsOnly = value.replace(/\-/g, '');
        
        // kun 6 cifre tilladt før bindesteg, og tilføjer bindestreg efter 6 cifre
        if (digitsOnly.length > 5) {
            value = digitsOnly.substring(0, 6) + '-' + digitsOnly.substring(6, 10);
        } else {
            value = digitsOnly;
        }
        
        this.value = value;
    });

    // Start søgning ved klik på knap
    searchBtn.addEventListener('click', performSearch);

    // start søgning ved enter tasten
    searchInput.addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });

    // Funktion der kalder API'et og håndterer svar
    function performSearch() {
        const searchTerm = searchInput.value.trim();
        

        // vis loader mens man venter på svar
        searchResults.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Søger...</span>
                </div>
            </div>
        `;

// kald API endpoint med query parametre
        fetch("/api/search_patients", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cpr: searchTerm })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("Fejl:" + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log(data);
            displayResults(data.Success, data.patient, data.hash)
        })
        .catch(err => {
            console.error(err);
            searchResults.innerHTML = '<div class="alert alert-danger">Søgning fejlede</div>';
        });
            
    }

    // Funktion til at vise søgeresultater i DOM'en
    function displayResults(success, patient, hash) {
        
        // Hvis ingen patienter blev fundet
        if (!patient || patient.length === 0) {
            searchResults.innerHTML = '<div class="alert alert-info">Ingen patienter fundet</div>';
            return;
        }

        // Byg HTML-streng til resultater
        let html = `
            <h4 class="mb-3">Søgeresultat</h4>
            <div class="table-responsive">
                <table class="table table-striped table-hover table-sm">
                    <thead>
                        <tr>
                            <th>CPR-nummer</th>
                            <th>Handling</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>${escapeHtml(patient)}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="goToDashboard('${escapeHtml(hash)}')">
                                    Patientdashboard
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        `;

        //sæt HTML ind i result containeren
        searchResults.innerHTML = html;
    }

    // Funktion til at sende hash til API og redirect
    function goToDashboard(hash) {
        fetch("/api/patient_dashboard", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cpr_hash: hash })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("Fejl:" + response.status);
            }
            // Fetch follows redirects automatically
            return response;
        })
        .then(response => {
            // If redirected, the page will load automatically
            window.location.href = response.url;
        })
        .catch(err => {
            console.error(err);
            alert('Kunne ikke åbne dashboard');
        });
    }

</script>
    

{% endblock %}

