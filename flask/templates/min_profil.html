{% extends "base.html" %}

{% block content %} 
<div class="container py-4">
    <h1>Patienter</h1>
    <p>Velkommen.</p>

    <!-- Flash Messages -->
    <div class="col-auto">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <!--category bruges til alert-success, alert danger..-->
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- Søgefelt til CPR-nummer-->
    <div class="my-4">
        <label for="patientSearch" class="form-label"><strong>Søg efter CPR-nummer</strong></label>
        <div class="input-group mb-3">
            <input
                type="text"
                class="form-control"
                id="patientSearch"
                name="patient_search"
                placeholder="xxxxxx-xxxx"
                inputmode="numeric"
                pattern="[0-9\-]*"
            >
            <!--Knappen der manuelt starter en søgning-->
            <button type="button" class="btn btn-primary" id="searchBtn">Søg</button>
        </div>
        <small class="form-text text-muted">Kun tal og bindestreg tilladt.</small>
    </div>

    <!-- Search Results Container -->
    <div id="searchResults" class="mt-4"></div>
</div>

<!--hent HTML-elementer -->
<script>
    const searchInput = document.getElementById('patientSearch');
    const searchBtn = document.getElementById('searchBtn');
    const searchResults = document.getElementById('searchResults');
    let searchTimeout; //debounce

    //funktion til at escape HTML-tegn i patient id (for at ungå xss)
    function escapeHtml(str) {
        if (str === null || str === undefined) return  '';
        return str
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
    
    // Bindestreg automatisk indsættes efter 6 cifre
    searchInput.addEventListener('input', function(e) {
        // fjerner alle tal der ikke er tal eller bindestreg
        let value = this.value.replace(/[^0-9\-]/g, '');
        
        // fjerner alle bindestreger for at arbejde med rene tal
        let digitsOnly = value.replace(/\-/g, '');
        
        // kun 6 cifre tilladt før bindesteg, og tilføjer bindestreg efter 6 cifre
        if (digitsOnly.length > 6) {
            value = digitsOnly.substring(0, 6) + '-' + digitsOnly.substring(6, 10);
        } else {
            value = digitsOnly;
        }
        
        this.value = value;
    });

    // Start søgning ved klik på knap
    searchBtn.addEventListener('click', performSearch);

    // start søgning ved enter, ellers debounce søgnig mens man skriver
    searchInput.addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
            // søg med det samme
            performSearch();
        } else {
            // Ryd den forrige timeout
            clearTimeout(searchTimeout);
            // Hvis der er mindst 2 tegn, vent 300ms og søg
            if (this.value.trim().length >= 2) {
                searchTimeout = setTimeout(performSearch, 300);
            } else if (this.value.trim().length === 0) {
                // hvis feltet er tomt, ryd resultater
                searchResults.innerHTML = '';
            }
        }
    });

    // Funktion der kalder API'et og håndterer svar
    function performSearch() {
        const searchTerm = searchInput.value.trim();
        
        // simpel validering, kræv mindst 2 tegn
        if (searchTerm.length < 2) {
            searchResults.innerHTML = '<div class="alert alert-info">Skriv mindst 2 tegn for at søge</div>';
            return;
        }

        // vis loader mens man venter på svar
        searchResults.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Søger...</span>
                </div>
            </div>
        `;

        // kald API endpoint med query parametre
        fetch(`/api/search_patients?query=${encodeURIComponent(searchTerm)}`)
            .then(response => {
                // hvis servern svarer med fejlstatus, kast en fejl 
                if (!response.ok) {
                    throw new Error('Fejl:' + response.status);
                }
                // konverter svaret til JSON
                return response.json();
        })
        .then(data => {
                // forudsætter at API'et returnerer { succes patients, count, message}
                if (data.success) {
                    displayResults(data.patients, data.count);
                } else {
                    searchResults.innerHTML = `<div class="alert alert-warning">Fejl: ${data.message || 'Kunne ikke søge'}</div>`;
                }
            })
            .catch(error => {
                // netværksfejl eller kastede fejl overnfor
                console.error('Search error:', error);
                searchResults.innerHTML = `<div class="alert alert-danger">Fejl ved søgning: ${error.message}</div>`;
            });
    }
    // Funktion til at vise søgeresultater i DOM'en
    function displayResults(patients, count) {
        // Hvis ingen patienter blev fundet
        if (!patients || patients.length === 0) {
            searchResults.innerHTML = '<div class="alert alert-info">Ingen patienter fundet</div>';
            return;
        }

        // Byg HTML-streng til resultater
        let html = `
            <h4 class="mb-3">Søgeresultater (<strong>${count}</strong> fundet)</h4>
            <div class="table-responsive">
                <table class="table table-striped table-hover table-sm">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>CPR-nummer</th>
                            <th>Patient ID</th>
                        </tr>
                    </thead>
                <tbody>
        `;

        patients.forEach((patient, index) => {
            html += `
            <thead>
                <tr>
                    <td>${index + 1}</td>
                    <td>${escapeHtml(patient.id)}</td>
                    <td>${patient.cpr ? escapeHtml(patient.cpr) : ''}</td>
                </tr>
            </thead>

            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
        `;

        //sæt HTML ind i result containeren
        searchResults.innerHTML = html;
    }
</script>





<div class="container py-4">
  <div class="row">
    <div class="col">
      <h1 class="h3 mb-1">User Profile</h1>
      <p class="text-muted">Hejsa, {{ current_user.name }}!</p>
    </div>
    <div class="col">
      {# Flash messages #}
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, msg in messages %}
          <div class= "mt-1 alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endwith %}
    </div>
  </div>
<div class="card shadow-sm p-4">
    <table class="table table-striped mb-0">
        <thead>
            <tr>
                <p>We have the following details saved about you, <!--{{ current_user.name }} {{ current_user.lastname }}.</p> -->
                <th>Name</th><th>Lastname</th><th>Email</th><th>Username</th>
            </tr>
        </thead>
    </table>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form      = document.getElementById('passwordForm');
  const submitBtn = form.querySelector('button[type="submit"]');
  const fields    = form.querySelectorAll('input[required]');

  function updateButtonState() {
    const allFilled = Array.from(fields).every(i => i.value.trim() !== '');
    submitBtn.disabled = !allFilled;
  }

  submitBtn.onclick = async () => {   
    if (newPassword !== confirmPassword) {
      alert("New password and confirmation do not match.");
      return;
    }
    location.reload();
  }

  fields.forEach(i => i.addEventListener('input', updateButtonState));
  updateButtonState();
});
</script>

{% endblock %}